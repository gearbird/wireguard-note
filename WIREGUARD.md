# Setup WireGuard
Note: Assume Ubuntu as the OS

This is only a minimal setup for a VPN with a single node bouncing server

## Login Into Server
Assume ```remoteserver1``` has been configured in SSH client

```ssh remoteserver1```

## Enable Server Forwarding
Both IPv4 and IPv6 forwarding need to be enabled

Use editor to uncommend two lines in ```/etc/sysctl.conf```

```net.ipv4.ip_forward=1```

```net.ipv6.conf.all.forwarding=1```

Apply the changes

```sudo sysctl -p /etc/sysctl.conf```

## Install WireGuard
```sudo apt update```

```sudo apt install wireguard```

## Add WireGuard Config File
Create a folder for WireGuard

```mkdir ~/wg && cd ~/wg```

Generate private key and make it read only

```wg genkey >> wg-private.key && chmod 400 wg-private.key```

Create config file, link it to current folder for convenience

```sudo touch /etc/wireguard/wg0.conf```

```ln -s /etc/wireguard/wg0.conf wg0.conf```

Edit config file ```wg0.conf``` with content below

(Note: See comments after ```#``` for explanation, comments are not required in real config file)

```
# Configure this bouncing server itself
[Interface]

# The UDP port that WireGuard exposes on this server
ListenPort = 9999

# Use the content of wg-private.key file, the read only file we created
PrivateKey = WJTvqUSY3ulPDuPx/OX6XtERq+YLzt/C223YeMTSWkc=

# Define the subnet that this VPN uses and the private IP of the server node
# In this case, the VPN subnet gives at most 256 addresses
# In this case, the 4th section of the IP address is assignable
# The subnet should not conflict with the physical subnet of any device that joins the VPN
Address = 192.168.120.40/24

# Add additional commands to run when WireGuard is up or down
# No change is needed for a minimal setup
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 

PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE


# Configure the peer devices that can connect directly to this bouncing server
# As many as we want, each peer should start with [Peer]
[Peer]

# For convenience, generate the public key from the client and copy here
# The official client of WireGuard (Windows/Mac/iOS) can generate it easily 
PublicKey = TXBxnJVuikjXk0+IXq62S2eduqjP6vKElWnMBYBxnXM=

# This will allow client with private IP 192.168.120.10 to connect to the server
# The subnet mask is set to 32 because we configure only one IP for one device
# Public key and IP are bound together for a deivce
AllowedIPs = 192.168.120.10/32

PersistentKeepalive = 20
```

Server side config is done, let's prepare the client config file in advance

We print the public key of server by ```wg pubkey < wg-private.key```

Assume the public IP of the server is ```40.87.100.12```

The corresponding WireGuard config file on client side should be something like below

(Note: it's not needed on server side)

```
[Interface]

# This is usually auto-generated by WireGuard client
PrivateKey = mIBEwKIvNsyWxGUhOX6Az1LKEVoX6QeDGAnWEg7r6XI=

Address = 192.168.120.10/32

DNS = 8.8.8.8

[Peer]

# This is the public key of the server
PublicKey = z7+52IbQNGBtpROzK4lzLWezjnVG7C0rDGhG5WCqZzk=

AllowedIPs = 0.0.0.0/0

# The public IP & port of the bouncing server
Endpoint = 40.87.100.12:9999

PersistentKeepalive = 20
```

## Run WireGuard On Server

```sudo wg-quick up wg0```

To apply a change in config file, restarting is required

```sudo wg-quick down wg0 && sudo wg-quick up wg0```

## Check Firewall
Make sure firewall is open for WireGuard, in this case it's UDP 9999

Usually it has to be explicitly configured at the cloud provider portal


[Back to README.md](README.md)